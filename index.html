<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>kuview</title>
</head>

<body>
  <script>
    console.log('[Main] Initializing Web Worker for KuView WASM.');
    const worker = new Worker('/static/worker.js'); // Ensure worker.js is in public directory

    window.kuviewEventQueue = [];

    // Temporary event handler to queue events before React is fully ready
    window.kuview = (event) => {
      console.log('[Main] Queuing event via temp window.kuview:', event);
      window.kuviewEventQueue.push(event);
    };

    worker.onmessage = (e) => {
      // Pass the event from the worker to the current window.kuview handler
      // This allows React to take over window.kuview when it mounts
      if (e.data && e.data.type === 'WORKER_ERROR') {
        console.error('[Main] Received error from worker:', e.data.error);
        // Handle worker error appropriately, e.g., display a message to the user
        const rootDiv = document.getElementById('root');
        if (rootDiv) {
          rootDiv.innerHTML =
            '<p style="color: red; font-family: sans-serif; padding: 20px;">' +
            'Error initializing WebAssembly worker: ' + e.data.error +
            '<br/>Please check the console for more details.</p>';
        }
        return;
      }

      if (typeof window.kuview === 'function') {
        window.kuview(e.data);
      } else {
        // Fallback: should ideally be caught by the queueing version of window.kuview
        console.warn('[Main] window.kuview not a function, pushing to queue directly.');
        window.kuviewEventQueue.push(e.data);
      }
    };

    worker.onerror = (error) => {
      console.error('[Main] Error from worker:', JSON.stringify(error));
      // You might want to display a user-friendly error message here too
      const rootDiv = document.getElementById('worker-error');
      if (rootDiv) {
        rootDiv.innerHTML =
          '<p style="color: red; font-family: sans-serif; padding: 20px;">' +
          'Critical error with WebAssembly worker: ' + error.message +
          '<br/>Please check the console for more details and refresh the page.</p>';
      }
    };

    // Initialize the worker by sending the HOST information
    worker.postMessage({
      type: 'INIT_WORKER',
      host: `${location.protocol}//${location.host}`
    });
    console.log('[Main] Sent INIT_WORKER to worker with host:', `${location.protocol}//${location.host}`);
  </script>
  <div id="worker-error"></div>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>

</html>